name: packing
on:
  release:
    types: [created]
    branches:
      - master
jobs:
    build-project:
      name: build java application
      runs-on: ubuntu-latest
      steps:
        - name: checkout Code
          uses: actions/checkout@v2
        - name: setup java
          uses: actions/setup-java@v2
          with:
            distribution: 'zulu'
            java-version: '11'
        - name: caching dependences
          uses: actions/cache@v2
          with:
            path: dependencies/
            key: ${{ runner.os }}-${{ steps.get-date.outputs.date }}-${{ hashFiles('**/lockfiles') }}
        - name: build code
          run: ./gradlew build --info
        - name: upload to artifacts
          uses: actions/upload-artifact@v2
          with:
            name: build
            path: build
        - uses: octokit/request-action@v2.x
          id: get_latest_release
          with:
             route: GET /repos/:repository/releases/latest
             repository: ${{ github.repository }}
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        - name: get upload url
          id: get_upload_url
          run: |
              url=$(echo "$response" | jq -r '.upload_url')
              echo "::set-output name=url::$url"
          env: 
              response:  ${{ steps.get_latest_release.outputs.data }}

        - name: Download the artifact
          uses: actions/download-artifact@v1
          with:
            name: build
            path: ./
        - name: Display structure of downloaded files
          run: ls -R
        - name: Upload Release Asset
          id: upload-release-asset 
          uses: actions/upload-release-asset@v1
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
              upload_url: ${{ steps.get_upload_url.outputs.url}} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
              asset_path: build.tar.gz
              asset_name: build.tar.gz
              asset_content_type: application/zip
